name: CI Fast

on:
  workflow_call:

permissions: read-all

jobs:
  ci-guardrails:
    name: Guardrails (proxy + format)
    # Draft PRs skip; ready PRs + pushes + merge queue enforce core repo guardrails
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
        with: { fetch-depth: 1 }
      - name: Short-circuit for docs-only / empty-diff PR updates
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail

          git fetch origin "${{ github.base_ref }}" --depth=1
          CHANGED_FILES=$(git diff --name-only "origin/${{ github.base_ref }}" HEAD)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No diff vs base branch (merge-only / empty PR update). Skipping guardrails."
            exit 0
          fi

          # Match the old trigger-level ignore behavior (but keep CI runnable for empty diffs)
          if echo "$CHANGED_FILES" | grep -v -E '^(docs/|\.vscode/|.*\.md$)' | wc -l | grep -q '^0$'; then
            echo "Docs-only change. Skipping guardrails."
            exit 0
          fi
      - uses: ./.github/actions/setup-node-pnpm
      - name: Next.js proxy guard
        run: pnpm run next:proxy-guard
      - name: Format check (Biome)
        run: pnpm run format:check

  ci-fast-checks:
    name: Fast checks (typecheck + lint)
    # Draft PRs skip; ready PRs + pushes + merge queue run fast checks in parallel
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        check: [typecheck, lint]
    steps:
      - uses: actions/checkout@v6
        with: { fetch-depth: 1 }
      - name: Short-circuit for docs-only / empty-diff PR updates
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail

          git fetch origin "${{ github.base_ref }}" --depth=1
          CHANGED_FILES=$(git diff --name-only "origin/${{ github.base_ref }}" HEAD)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No diff vs base branch (merge-only / empty PR update). Skipping fast checks."
            exit 0
          fi

          # Match the old trigger-level ignore behavior (but keep CI runnable for empty diffs)
          if echo "$CHANGED_FILES" | grep -v -E '^(docs/|\.vscode/|.*\.md$)' | wc -l | grep -q '^0$'; then
            echo "Docs-only change. Skipping fast checks."
            exit 0
          fi
      - uses: ./.github/actions/setup-node-pnpm
      - name: Cache TypeScript artifacts
        if: ${{ matrix.check == 'typecheck' }}
        uses: actions/cache@v5
        with:
          path: .cache/tsbuildinfo
          key: ${{ runner.os }}-tsc-${{ github.ref }}-${{ hashFiles('tsconfig.json', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-tsc-${{ github.ref }}-
            ${{ runner.os }}-tsc-
      - name: Cache ESLint artifacts
        if: ${{ matrix.check == 'lint' }}
        uses: actions/cache@v5
        with:
          path: .cache/eslint
          key: ${{ runner.os }}-eslint-${{ hashFiles('pnpm-lock.yaml', 'eslint.config.js', '.eslintrc*') }}
          restore-keys: |
            ${{ runner.os }}-eslint-
      - name: Run fast/lint check
        run: |
          if [[ "${{ matrix.check }}" == "typecheck" ]]; then
            pnpm run typecheck
          else
            pnpm run lint
          fi

  ci-fast:
    name: ci-fast
    # Gate for PRs, pushes, and merge queue: aggregate fast checks
    needs: [ci-fast-checks, ci-guardrails]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: All fast checks passed
        run: |
          echo "ci-fast passed: Typecheck and Lint succeeded"
