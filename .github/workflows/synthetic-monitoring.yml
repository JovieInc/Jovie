permissions:
  contents: read
name: Production Synthetic Monitoring

"on":
  schedule:
    # Run every 15 minutes during business hours (8 AM - 8 PM PST = 16:00-04:00 UTC)
    - cron: '*/15 16-23 * * *'
    - cron: '*/15 0-4 * * *'
    # Run every 30 minutes during off-hours (4 AM - 4 PM PST = 05:00-15:00 UTC)
    - cron: '0,30 5-15 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  synthetic-test:
    name: Golden Path Synthetic Test
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Safety check - only run on schedule or manual dispatch
        if: ${{ github.event_name != 'schedule' && github.event_name != 'workflow_dispatch' }}
        run: |
          echo "âŒ Synthetic monitoring should only run on schedule or manual dispatch, not on '${{ github.event_name }}'"
          echo "This workflow was incorrectly triggered. Exiting to prevent unnecessary resource usage."
          exit 1

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Cache Playwright Browsers
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers (chromium only)
        run: pnpm --filter=@jovie/web exec playwright install --with-deps chromium

      - name: Run Golden Path Test
        env:
          BASE_URL: https://jov.ie
          PLAYWRIGHT_TEST_BASE_URL: https://jov.ie
          # Use production Clerk for synthetic tests
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY_PROD }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY_PROD }}
          # Enable synthetic monitoring mode
          E2E_SYNTHETIC_MODE: 'true'
          E2E_ENVIRONMENT: production
        run: |
          # Run only the golden path test
          npx playwright test tests/e2e/golden-path.spec.ts --reporter=json --output=test-results
        continue-on-error: true

      - name: Parse test results
        id: test-results
        run: |
          RESULTS_DIR="test-results"
          if [ -f "$RESULTS_DIR/results.json" ]; then
            FAILED_TESTS=$(jq -r '[.suites[].specs[] | select(.outcome == "unexpected") | .title] | join("\n")' "$RESULTS_DIR/results.json")
            TOTAL_TESTS=$(jq -r '[.suites[].specs[]] | length' "$RESULTS_DIR/results.json")
            PASSED_TESTS=$(jq -r '[.suites[].specs[] | select(.outcome == "expected")] | length' "$RESULTS_DIR/results.json")

            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
            echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
            echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            if [ "$PASSED_TESTS" -lt "$TOTAL_TESTS" ]; then
              echo "test_status=failed" >> $GITHUB_OUTPUT
            else
              echo "test_status=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "test_status=error" >> $GITHUB_OUTPUT
            echo "failed_tests=Test results file not found" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: synthetic-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: Fail job if tests failed
        if: steps.test-results.outputs.test_status == 'failed'
        run: |
          echo "Marking job as failed due to test failures"
          exit 1

      - name: Send Slack Alert on Failure
        if: steps.test-results.outputs.test_status != 'passed'
        uses: 8398a7/action-slack@77eaa4f1c608a7d68b38af4e3f739dcd8cba273e # v3.19.0
        with:
          status: custom
          channel: '#alerts-production'
          author_name: 'Synthetic Monitoring'
          custom_payload: |
            {
              "text": "ðŸš¨ Golden Path Test Failed - jov.ie",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    {
                      "title": "URL",
                      "value": "https://jov.ie",
                      "short": true
                    },
                    {
                      "title": "Failed Tests",
                      "value": "```\n${{ steps.test-results.outputs.failed_tests }}\n```",
                      "short": false
                    },
                    {
                      "title": "Action",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send Slack Success Notification (Scheduled Summary)
        if: steps.test-results.outputs.test_status == 'passed' && github.event_name == 'schedule'
        uses: 8398a7/action-slack@77eaa4f1c608a7d68b38af4e3f739dcd8cba273e # v3.19.0
        with:
          status: custom
          channel: '#monitoring'
          author_name: 'Synthetic Monitoring'
          custom_payload: |
            {
              "text": "âœ… Golden Path Health Check - jov.ie",
              "attachments": [
                {
                  "color": "good",
                  "fields": [
                    {
                      "title": "URL",
                      "value": "https://jov.ie",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "All critical user journeys passing",
                      "short": false
                    },
                    {
                      "title": "Tests Passed",
                      "value": "${{ steps.test-results.outputs.passed_tests }}/${{ steps.test-results.outputs.total_tests }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
