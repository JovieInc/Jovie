name: Manual Promotion (Fallback)

# FALLBACK: Manual promotion workflow
# Primary promotion path is automatic in ci.yml (promote job on push to main)
# This workflow is for manual override when the automatic promotion fails or is skipped

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

concurrency:
  group: auto-promote-production
  cancel-in-progress: false

jobs:
  open-promotion-pr:
    name: Manual promotion PR (main -> production)
    runs-on: ubuntu-latest
    steps:
      - name: Ensure not from bot loop
        if: github.actor == 'github-actions[bot]'
        run: |
          echo "Skipping to avoid bot loop"
          exit 0

      - name: Check for existing promotion PR
        id: check_pr
        uses: actions/github-script@v8
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'production',
              head: `${context.repo.owner}:main`,
              per_page: 10
            });
            if (prs.length > 0) {
              core.info(`Existing promotion PR #${prs[0].number} found.`);
              core.setOutput('exists', 'true');
              core.setOutput('number', String(prs[0].number));
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Open promotion PR
        if: steps.check_pr.outputs.exists != 'true'
        id: create_pr
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'chore(release): promote main to production';
            const body = [
              'This PR promotes the latest changes from `main` to `production`. ',
              '',
              '- This PR was opened via the manual fallback workflow (workflow_dispatch).',
              '- Primary path for promotion is CI-gated in `.github/workflows/ci.yml` after a successful main deploy.',
              '- The auto-merge workflow will wait for full checks (Build, Unit Tests, E2E Tests, Drizzle Check).',
              '',
              'If anything looks off, close this PR to halt promotion.'
            ].join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: 'main',
              base: 'production',
              body,
              maintainer_can_modify: true
            });
            core.info(`Opened promotion PR #${pr.number}`);
            core.setOutput('number', String(pr.number));
