name: Visual & A11y Tests

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/components/**'
      - 'apps/web/.storybook/**'
      - 'packages/ui/**'

# Cancel in-progress runs for the same PR
concurrency:
  group: visual-a11y-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  storybook-a11y:
    name: Storybook A11y Checks
    runs-on: ubuntu-latest
    # Non-blocking: continue even if this job fails
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Storybook
        run: pnpm --filter web build-storybook
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Run Storybook Tests (A11y)
        id: a11y-test
        run: |
          npx concurrently -k -s first -n "SB,TEST" -c "magenta,cyan" \
            "npx http-server apps/web/storybook-static -p 6006 --silent" \
            "npx wait-on tcp:127.0.0.1:6006 && pnpm --filter web storybook:test --url http://127.0.0.1:6006"
        continue-on-error: true

      - name: A11y Results Summary
        if: always()
        run: |
          if [ "${{ steps.a11y-test.outcome }}" == "failure" ]; then
            echo "::warning::âš ï¸ Accessibility violations detected in Storybook components. Check the test output above for details."
            echo ""
            echo "## ðŸ” A11y Check Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Accessibility violations detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some components have accessibility issues (contrast, labels, etc.)." >> $GITHUB_STEP_SUMMARY
            echo "These are logged as warnings - review the job output for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To run locally: \`pnpm --filter web storybook:test\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… A11y Check Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All Storybook components passed accessibility checks." >> $GITHUB_STEP_SUMMARY
          fi

  playwright-visual:
    name: Playwright Visual Regression
    runs-on: ubuntu-latest
    # Non-blocking: continue even if this job fails
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm --filter web exec playwright install chromium --with-deps

      - name: Run Visual Regression Tests
        id: visual-test
        run: pnpm --filter web e2e:visual
        continue-on-error: true
        env:
          CI: true
          # Skip auth-required tests in CI without secrets
          E2E_SKIP_AUTH: true

      - name: Upload Visual Diff Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff-report
          path: |
            apps/web/test-results/
            apps/web/playwright-report/
          retention-days: 7

      - name: Visual Test Results Summary
        if: always()
        run: |
          if [ "${{ steps.visual-test.outcome }}" == "failure" ]; then
            echo "::warning::âš ï¸ Visual differences detected. Check the artifacts for diff images."
            echo ""
            echo "## ðŸ–¼ï¸ Visual Regression Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Visual differences detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some pages have visual changes from the baseline." >> $GITHUB_STEP_SUMMARY
            echo "Download the artifacts to review diff images." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "If changes are intentional, update snapshots:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pnpm --filter web e2e:visual:update" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Visual Regression Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All visual tests passed - no unexpected changes detected." >> $GITHUB_STEP_SUMMARY
          fi
