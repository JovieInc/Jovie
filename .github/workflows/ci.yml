name: CI Fast

on:
  pull_request:
    branches: [preview, production]
  push:
    branches: [preview, production]
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Ship-it bypass: Skip all checks for quick fixes
  check-ship-it:
    name: Check Ship-It Label
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      skip-checks: ${{ steps.check.outputs.skip }}
    steps:
      - id: check
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'ship-it') }}" == "true" ]]; then
            echo "üöÄ Ship-it label detected - bypassing all checks!"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  # FAST CHECKS: 90 seconds or bust
  fast-checks:
    name: Fast Checks
    needs: [check-ship-it]
    if: needs.check-ship-it.outputs.skip-checks != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 2  # YC: Force optimization
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install deps (30s target)
        run: |
          # Use npm ci for speed, not pnpm
          npm ci --prefer-offline --no-audit --no-fund
      
      - name: Parallel checks (60s target)
        run: |
          # Run everything in parallel, fail on first error
          npm run typecheck &
          TYPECHECK_PID=$!
          
          npm run lint --max-warnings=0 &
          LINT_PID=$!
          
          npm run test:unit:fast 2>/dev/null || npm run test &
          TEST_PID=$!
          
          # Wait for all, exit on first failure
          wait $TYPECHECK_PID || exit 1
          wait $LINT_PID || exit 1
          wait $TEST_PID || exit 1
          
          echo "‚úÖ All fast checks passed!"

  # Revenue-critical E2E only (nightly/scheduled)
  # Removed from PR flow per YC principles

  # Build check only for production
  build-check:
    name: Build (Production Only)
    needs: [fast-checks]
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'production'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci --prefer-offline --no-audit --no-fund
      - run: npm run build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}

  # Simple success gate
  ci-pass:
    name: CI Pass
    needs: [fast-checks]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.fast-checks.result }}" == "success" ]] || [[ "${{ needs.check-ship-it.outputs.skip-checks }}" == "true" ]]; then
            echo "‚úÖ CI passed or ship-it bypass active"
            exit 0
          else
            echo "‚ùå CI failed"
            exit 1
          fi