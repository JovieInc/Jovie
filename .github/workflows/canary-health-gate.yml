name: Canary Health Gate

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      deployment_url:
        description: Base URL for the deployment to verify.
        required: true
        type: string
      fallback_health_url:
        description: Fallback health check endpoint if the deployment URL is rate-limited.
        required: true
        type: string
      wait_seconds:
        description: Seconds to wait before the first health check.
        required: false
        default: 30
        type: number
    secrets:
      VERCEL_AUTOMATION_BYPASS_SECRET:
        required: false

jobs:
  canary-health-gate:
    name: Canary health gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Canary health check
        env:
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
          DEPLOYMENT_URL: ${{ inputs.deployment_url }}
          FALLBACK_HEALTH_URL: ${{ inputs.fallback_health_url }}
          WAIT_SECONDS: ${{ inputs.wait_seconds }}
        run: |
          echo "Running canary health check..."
          deployment_url="${DEPLOYMENT_URL}"
          health_url_primary="${deployment_url%/}/api/health"
          health_url_fallback="${FALLBACK_HEALTH_URL}"
          health_url="$health_url_primary"

          # Wait a moment for deployment to be ready
          sleep "${WAIT_SECONDS}"

          USER_AGENT="Mozilla/5.0 (compatible; JovieCI/1.0; +https://jov.ie)"
          COOKIE_JAR="$(mktemp)"

          # Vercel Deployment Protection / Bot protection bypass for automation
          # See: https://vercel.com/docs/deployment-protection/methods-to-bypass-deployment-protection/protection-bypass-automation
          BYPASS_SECRET="${VERCEL_AUTOMATION_BYPASS_SECRET:-}"
          BYPASS_ARGS=()
          if [ -n "$BYPASS_SECRET" ]; then
            BYPASS_ARGS+=(
              -H "x-vercel-protection-bypass: $BYPASS_SECRET"
              -H "x-vercel-set-bypass-cookie: true"
              -c "$COOKIE_JAR"
              -b "$COOKIE_JAR"
            )
          else
            echo "⚠ VERCEL_AUTOMATION_BYPASS_SECRET not set; canary may hit Vercel Security Checkpoint (HTTP 429)."
          fi

          attempt=1
          max_attempts=8
          response_code="000"
          canary_inconclusive="false"
          while [ $attempt -le $max_attempts ]; do
            response=$(curl -s -L -A "$USER_AGENT" -H "Accept: application/json" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" -w "\n%{http_code}" "$health_url" || echo "\n000")
            response_code="${response##*$'\n'}"

            if [ "$response_code" = "200" ]; then
              break
            fi

            if [ "$response_code" = "429" ]; then
              sleep_seconds=$((attempt * 5))
              echo "⚠ Canary got HTTP 429 (attempt $attempt/$max_attempts). Retrying in ${sleep_seconds}s..."
              sleep "$sleep_seconds"
              attempt=$((attempt + 1))
              continue
            fi

            echo "❌ Canary failed: HTTP $response_code"
            exit 1
          done

          if [ "$response_code" != "200" ]; then
            if [ "$response_code" = "429" ]; then
              echo "⚠ Canary still rate-limited on deployment URL after retries. Falling back to ${health_url_fallback}..."
              health_url="$health_url_fallback"

              attempt=1
              max_attempts=5
              response_code="000"
              while [ $attempt -le $max_attempts ]; do
                response=$(curl -s -L -A "$USER_AGENT" -H "Accept: application/json" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" -w "\n%{http_code}" "$health_url" || echo "\n000")
                response_code="${response##*$'\n'}"

                if [ "$response_code" = "200" ]; then
                  break
                fi

                if [ "$response_code" = "429" ]; then
                  response_body="${response%$'\n'*}"
                  body_preview="${response_body:0:300}"
                  sleep_seconds=$((attempt * 15))
                  echo "⚠ Canary fallback got HTTP 429 (attempt $attempt/$max_attempts). Retrying in ${sleep_seconds}s..."
                  echo "429 response preview: ${body_preview}"
                  sleep "$sleep_seconds"
                  attempt=$((attempt + 1))
                  continue
                fi

                echo "❌ Canary fallback failed: HTTP $response_code"
                exit 1
              done

              if [ "$response_code" != "200" ]; then
                if [ "$response_code" = "429" ]; then
                  if [ -z "$BYPASS_SECRET" ]; then
                    echo "⚠ Canary inconclusive: Vercel returned HTTP 429 Security Checkpoint even after retries."
                    echo "⚠ Not failing deploy because bypass secret is unavailable."
                    canary_inconclusive="true"
                  else
                    echo "❌ Canary failed: HTTP 429 Security Checkpoint even though bypass secret is set."
                    exit 1
                  fi
                else
                  echo "❌ Canary fallback failed after retries: HTTP $response_code"
                  exit 1
                fi
              fi
            else
              echo "❌ Canary failed after retries: HTTP $response_code"
              exit 1
            fi
          fi

          if [ "$canary_inconclusive" = "true" ]; then
            exit 0
          fi

          health_content=$(curl -s -L -A "$USER_AGENT" -H "Accept: application/json" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" "$health_url" || echo "")
          if [[ "$health_content" != *'"status":"ok"'* ]]; then
            echo "❌ Canary failed: Health status not ok"
            echo "Health response: $health_content"
            exit 1
          fi

          if [[ "$health_content" != *'"database":{"ok":true'* ]]; then
            echo "❌ Canary failed: Database health not ok"
            echo "Health response: $health_content"
            exit 1
          fi

          echo "✅ Health endpoint passed"

          # CRITICAL: Verify homepage renders (not just API health)
          echo "Checking homepage renders..."
          homepage_url="${deployment_url%/}/"
          homepage_response=$(curl -s -L -A "$USER_AGENT" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" -w "\n%{http_code}" "$homepage_url" || echo "\n000")
          homepage_code="${homepage_response##*$'\n'}"
          homepage_body="${homepage_response%$'\n'*}"

          if [ "$homepage_code" != "200" ]; then
            echo "❌ Canary failed: Homepage returned HTTP $homepage_code"
            exit 1
          fi

          # Check homepage has actual content (not blank or error page)
          if [ ${#homepage_body} -lt 1000 ]; then
            echo "❌ Canary failed: Homepage body too short (${#homepage_body} chars) - likely broken"
            exit 1
          fi

          # Check for common error indicators
          if echo "$homepage_body" | grep -qi "application error\|internal server error\|something went wrong\|error occurred"; then
            echo "❌ Canary failed: Homepage contains error message"
            exit 1
          fi

          echo "✅ Canary passed: Deployment healthy and homepage renders"
