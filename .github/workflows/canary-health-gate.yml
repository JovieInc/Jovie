name: Canary Health Gate

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      deployment_url:
        description: Base URL for the deployment to verify.
        required: true
        type: string
      fallback_health_url:
        description: Fallback health check endpoint if the deployment URL is rate-limited.
        required: true
        type: string
      wait_seconds:
        description: Seconds to wait before the first health check.
        required: false
        default: 30
        type: number
    outputs:
      canary_status:
        description: 'Canary verification status: verified, failed'
        value: ${{ jobs.canary-health-gate.outputs.canary_status }}
    secrets:
      VERCEL_AUTOMATION_BYPASS_SECRET:
        required: false
      VERCEL_TOKEN:
        required: true
      VERCEL_ORG_ID:
        required: true
      VERCEL_PROJECT_ID:
        required: true

jobs:
  canary-health-gate:
    name: Canary health gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      canary_status: ${{ steps.canary-check.outputs.canary_status }}
    steps:
      - name: Canary health check
        id: canary-check
        env:
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
          DEPLOYMENT_URL: ${{ inputs.deployment_url }}
          FALLBACK_HEALTH_URL: ${{ inputs.fallback_health_url }}
          WAIT_SECONDS: ${{ inputs.wait_seconds }}
        run: |
          echo "Running canary health check..."
          deployment_url="${DEPLOYMENT_URL}"
          health_url_primary="${deployment_url%/}/api/health"
          health_url_fallback="${FALLBACK_HEALTH_URL}"
          health_url="$health_url_primary"

          # Wait a moment for deployment to be ready
          sleep "${WAIT_SECONDS}"

          USER_AGENT="Mozilla/5.0 (compatible; JovieCI/1.0; +https://jov.ie)"
          COOKIE_JAR="$(mktemp)"

          # Vercel Deployment Protection / Bot protection bypass for automation
          # See: https://vercel.com/docs/deployment-protection/methods-to-bypass-deployment-protection/protection-bypass-automation
          BYPASS_SECRET="${VERCEL_AUTOMATION_BYPASS_SECRET:-}"
          BYPASS_ARGS=()
          if [ -n "$BYPASS_SECRET" ]; then
            BYPASS_ARGS+=(
              -H "x-vercel-protection-bypass: $BYPASS_SECRET"
              -H "x-vercel-set-bypass-cookie: true"
              -c "$COOKIE_JAR"
              -b "$COOKIE_JAR"
            )
          else
            echo "âš  VERCEL_AUTOMATION_BYPASS_SECRET not set; canary may hit Vercel Security Checkpoint (HTTP 429)."
          fi

          attempt=1
          max_attempts=8
          response_code="000"
          canary_inconclusive="false"
          while [ $attempt -le $max_attempts ]; do
            response=$(curl -s -L -A "$USER_AGENT" -H "Accept: application/json" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" -w "\n%{http_code}" "$health_url" || echo "\n000")
            response_code="${response##*$'\n'}"

            if [ "$response_code" = "200" ]; then
              break
            fi

            if [ "$response_code" = "429" ]; then
              sleep_seconds=$((attempt * 5))
              echo "âš  Canary got HTTP 429 (attempt $attempt/$max_attempts). Retrying in ${sleep_seconds}s..."
              sleep "$sleep_seconds"
              attempt=$((attempt + 1))
              continue
            fi

            echo "âŒ Canary failed: HTTP $response_code"
            echo "canary_status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          done

          if [ "$response_code" != "200" ]; then
            if [ "$response_code" = "429" ]; then
              echo "âš  Canary still rate-limited on deployment URL after retries. Falling back to ${health_url_fallback}..."
              health_url="$health_url_fallback"

              attempt=1
              max_attempts=5
              response_code="000"
              while [ $attempt -le $max_attempts ]; do
                response=$(curl -s -L -A "$USER_AGENT" -H "Accept: application/json" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" -w "\n%{http_code}" "$health_url" || echo "\n000")
                response_code="${response##*$'\n'}"

                if [ "$response_code" = "200" ]; then
                  break
                fi

                if [ "$response_code" = "429" ]; then
                  response_body="${response%$'\n'*}"
                  body_preview="${response_body:0:300}"
                  sleep_seconds=$((attempt * 15))
                  echo "âš  Canary fallback got HTTP 429 (attempt $attempt/$max_attempts). Retrying in ${sleep_seconds}s..."
                  echo "429 response preview: ${body_preview}"
                  sleep "$sleep_seconds"
                  attempt=$((attempt + 1))
                  continue
                fi

                echo "âŒ Canary fallback failed: HTTP $response_code"
                echo "canary_status=failed" >> "$GITHUB_OUTPUT"
                exit 1
              done

              if [ "$response_code" != "200" ]; then
                if [ "$response_code" = "429" ]; then
                  if [ -z "$BYPASS_SECRET" ]; then
                    echo "âŒ Canary FAILED: Vercel returned HTTP 429 Security Checkpoint even after retries."
                    echo "âŒ CRITICAL: Cannot verify deployment health - failing to prevent unverified production deploy."
                    echo "âŒ ACTION REQUIRED: Set VERCEL_AUTOMATION_BYPASS_SECRET to enable proper canary verification."
                    echo "canary_status=failed_unverified" >> "$GITHUB_OUTPUT"
                    exit 1
                  else
                    echo "âŒ Canary failed: HTTP 429 Security Checkpoint even though bypass secret is set."
                    echo "canary_status=failed" >> "$GITHUB_OUTPUT"
                    exit 1
                  fi
                else
                  echo "âŒ Canary fallback failed after retries: HTTP $response_code"
                  echo "canary_status=failed" >> "$GITHUB_OUTPUT"
                  exit 1
                fi
              fi
            else
              echo "âŒ Canary failed after retries: HTTP $response_code"
              echo "canary_status=failed" >> "$GITHUB_OUTPUT"
              exit 1
            fi
          fi

          # Note: canary_inconclusive is no longer used - we fail fast on unverified deployments

          health_content=$(curl -s -L -A "$USER_AGENT" -H "Accept: application/json" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" "$health_url" || echo "")
          if [[ "$health_content" != *'"status":"ok"'* ]]; then
            echo "âŒ Canary failed: Health status not ok"
            echo "Health response: $health_content"
            echo "canary_status=failed_health" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          if [[ "$health_content" != *'"database":{"ok":true'* ]]; then
            echo "âŒ Canary failed: Database health not ok"
            echo "Health response: $health_content"
            echo "canary_status=failed_database" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "âœ… Health endpoint passed"

          # CRITICAL: Verify homepage renders (not just API health)
          echo "Checking homepage renders..."
          homepage_url="${deployment_url%/}/"
          homepage_response=$(curl -s -L -A "$USER_AGENT" -H "Cache-Control: no-cache" "${BYPASS_ARGS[@]}" -w "\n%{http_code}" "$homepage_url" || echo "\n000")
          homepage_code="${homepage_response##*$'\n'}"
          homepage_body="${homepage_response%$'\n'*}"

          if [ "$homepage_code" != "200" ]; then
            echo "âŒ Canary failed: Homepage returned HTTP $homepage_code"
            echo "canary_status=failed_homepage" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Check homepage has actual content (not blank or error page)
          if [ ${#homepage_body} -lt 1000 ]; then
            echo "âŒ Canary failed: Homepage body too short (${#homepage_body} chars) - likely broken"
            echo "canary_status=failed_homepage" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Check for common error indicators
          if echo "$homepage_body" | grep -qi "application error\|internal server error\|something went wrong\|error occurred"; then
            echo "âŒ Canary failed: Homepage contains error message"
            echo "canary_status=failed_homepage" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "âœ… Canary passed: Deployment healthy and homepage renders"
          echo "canary_status=verified" >> "$GITHUB_OUTPUT"

      - name: Trigger automatic rollback on failure
        if: failure()
        run: |
          echo "ðŸ”´ Canary health check failed - triggering automatic rollback..."

          # Install Vercel CLI if not already available
          if ! command -v vercel &> /dev/null; then
            pnpm add -g vercel@latest
          fi

          # Attempt rollback to previous deployment
          # Using || true to prevent workflow failure if rollback command fails
          vercel rollback --yes --token "$VERCEL_TOKEN" 2>&1 || {
            echo "âš ï¸ Auto-rollback failed or not supported. Manual intervention required."
            echo "rollback_attempted=true" >> "$GITHUB_OUTPUT"
            echo "rollback_success=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          echo "âœ… Auto-rollback completed successfully"
          echo "rollback_attempted=true" >> "$GITHUB_OUTPUT"
          echo "rollback_success=true" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
