name: Test Performance Monitoring

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  performance-guard:
    name: Performance Guard
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run Performance Guard
        id: performance-guard
        run: |
          echo "Running performance guard..."
          pnpm test:guard
        continue-on-error: true

      - name: Performance Guard Results
        if: steps.performance-guard.outcome == 'failure'
        run: |
          echo "‚ùå Performance guard failed - tests are too slow!"
          echo "Run 'pnpm test:profile' locally for detailed analysis"
          exit 1

      - name: Success Message
        if: steps.performance-guard.outcome == 'success'
        run: |
          echo "‚úÖ All performance thresholds met!"
          echo "üöÄ Test suite is optimized for fast feedback"

  fast-tests:
    name: Fast Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run Fast Test Suite
        run: pnpm test:fast

  flaky-test-detection:
    name: Flaky Test Detection
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run on push to main (not PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Detect Flaky Tests
        run: pnpm test:flaky "" 5
        continue-on-error: true

      - name: Upload Quarantine Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: flaky-test-results
          path: tests/quarantine/
          retention-days: 30

  performance-report:
    name: Performance Report
    runs-on: ubuntu-latest
    timeout-minutes: 8
    # Only run on push to main (not PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Generate Performance Report
        run: pnpm test:profile

      - name: Upload Performance Baseline
        uses: actions/upload-artifact@v6
        with:
          name: performance-baseline
          path: test-performance-baseline.json
          retention-days: 90

      - name: Comment Performance Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            try {
              const baseline = JSON.parse(fs.readFileSync('test-performance-baseline.json', 'utf8'));
              const metrics = baseline.metrics;
              
              const comment = `## üìä Test Performance Report
              
              | Metric | Value | Target | Status |
              |--------|-------|--------|--------|
              | Total Duration | ${(metrics.totalDuration/1000).toFixed(1)}s | <60s | ${metrics.totalDuration < 60000 ? '‚úÖ' : '‚ùå'} |
              | Setup Time | ${(metrics.setupTime/1000).toFixed(1)}s | <10s | ${metrics.setupTime < 10000 ? '‚úÖ' : '‚ùå'} |
              | P95 | ${metrics.performanceStats.p95}ms | <200ms | ${metrics.performanceStats.p95 < 200 ? '‚úÖ' : '‚ùå'} |
              | Slow Tests | ${metrics.slowTests.length} | <5 | ${metrics.slowTests.length < 5 ? '‚úÖ' : '‚ùå'} |
              
              ${metrics.slowTests.length > 0 ? `
              ### üêå Slowest Tests
              ${metrics.slowTests.slice(0, 5).map((test, i) => 
                `${i+1}. ${test.name}: ${test.duration}ms`
              ).join('\n')}
              ` : ''}
              
              Run \`pnpm test:profile\` locally for detailed analysis.
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not create performance comment:', error.message);
            }
