name: PR Neon Branch

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, closed]

concurrency:
  group: ${{ github.workflow }}-pr-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  create_neon_branch:
    name: Create Neon Branch
    if: >
      github.event.action != 'closed' &&
      github.event.pull_request.head.repo.fork == false &&
      github.event.pull_request.base.ref == 'preview'
    runs-on: ubuntu-latest
    outputs:
      db_url: ${{ steps.create.outputs.db_url }}
      db_url_with_pooler: ${{ steps.create.outputs.db_url_with_pooler }}
    steps:
      - name: Create Neon Branch from PREVIEW
        id: create
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: preview/pr-${{ github.event.number }}
          parent: preview
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Checkout repository
        if: ${{ !github.event.pull_request.draft }}
        uses: actions/checkout@v4

      # Install only when we will run migrations
      - name: Setup Node
        if: ${{ !github.event.pull_request.draft }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Setup pnpm
        if: ${{ !github.event.pull_request.draft }}
        uses: pnpm/action-setup@v4

      - name: Install deps
        if: ${{ !github.event.pull_request.draft }}
        run: pnpm install --frozen-lockfile

      - name: Run Drizzle migrations (skip drafts)
        if: ${{ !github.event.pull_request.draft }}
        run: pnpm drizzle-kit push
        env:
          DATABASE_URL: ${{ steps.create.outputs.db_url }}

      - name: Comment on PR (created)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const number = pr.number;
            const isDraft = !!pr.draft;
            const body = [
              `Neon: created branch \`preview/pr-${number}\` from \`preview\`.`,
              isDraft ? `Migrations skipped (draft PR).` : `Drizzle migrations pushed.`,
            ].join(' ');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body,
            });

      # Optionally post schema diff comment (requires PR write permissions)
      # permissions:
      #   pull-requests: write
      # - uses: neondatabase/schema-diff-action@v1
      #   with:
      #     project_id: ${{ vars.NEON_PROJECT_ID }}
      #     compare_branch: preview/pr-${{ github.event.number }}
      #     api_key: ${{ secrets.NEON_API_KEY }}

  delete_neon_branch:
    name: Delete Neon Branch
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.head.repo.fork == false &&
      github.event.pull_request.base.ref == 'preview'
    runs-on: ubuntu-latest
    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: preview/pr-${{ github.event.number }}
          api_key: ${{ secrets.NEON_API_KEY }}
        continue-on-error: true

  reset_neon_branch_to_parent:
    name: Reset PR DB to PREVIEW parent
    if: >
      github.event_name == 'pull_request' &&
      (github.event.action == 'labeled' || github.event.action == 'synchronize' || github.event.action == 'opened' || github.event.action == 'reopened') &&
      contains(github.event.pull_request.labels.*.name, 'neon:reset') &&
      github.event.pull_request.head.repo.fork == false &&
      github.event.pull_request.base.ref == 'preview'
    runs-on: ubuntu-latest
    steps:
      - uses: neondatabase/reset-branch-action@v1
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          parent: true
          branch: preview/pr-${{ github.event.number }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Comment on PR (reset)
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.payload.pull_request.number;
            const body = `Neon: reset branch \`preview/pr-${number}\` to its parent (\`preview\`) due to label \`neon:reset\`.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body,
            });
